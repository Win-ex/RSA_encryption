<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RSA Encrypt - Generate & Encrypt</title>
<style>
:root{
  --bg:#0d1117;
  --card:#161b22;
  --panel:#1c2128;
  --muted:#c9d1d9;
  --accent:#58a6ff;
  --accent2:#2ea043;
  --border:#30363d;
}

* { margin:0; padding:0; box-sizing:border-box; }

html,body{
  height:100%;
  font-family:'Segoe UI',Arial,sans-serif;
  background:var(--bg);
  color:var(--muted);
  overflow-x:hidden;
}

@keyframes fadeIn {
  from { opacity:0; transform:translateY(20px); }
  to { opacity:1; transform:translateY(0); }
}

@keyframes slideIn {
  from { opacity:0; transform:translateX(-30px); }
  to { opacity:1; transform:translateX(0); }
}

@keyframes spin {
  from { transform:rotate(0deg); }
  to { transform:rotate(360deg); }
}

@keyframes pulse {
  0%, 100% { opacity:1; }
  50% { opacity:0.5; }
}

.nav{
  background:var(--card);
  border-bottom:1px solid var(--border);
  padding:16px 24px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 4px 12px rgba(0,0,0,0.3);
  animation:slideIn 0.5s ease;
}

.nav-title{
  font-size:20px;
  font-weight:700;
  color:var(--accent);
  display:flex;
  align-items:center;
  gap:10px;
}

.nav-links{
  display:flex;
  gap:12px;
}

.nav-btn{
  padding:8px 16px;
  background:transparent;
  color:var(--muted);
  border:1px solid var(--border);
  border-radius:6px;
  cursor:pointer;
  font-size:14px;
  font-weight:600;
  transition:all 0.3s ease;
  text-decoration:none;
  display:inline-block;
}

.nav-btn:hover{
  background:var(--accent);
  color:#071023;
  border-color:var(--accent);
  transform:translateY(-2px);
  box-shadow:0 4px 12px rgba(88,166,255,0.3);
}

.nav-btn.active{
  background:var(--accent);
  color:#071023;
  border-color:var(--accent);
}

.wrap{
  min-height:calc(100vh - 65px);
  padding:32px 24px;
  display:flex;
  justify-content:center;
}

.container{
  width:100%;
  max-width:1000px;
  animation:fadeIn 0.6s ease;
}

.section{
  background:var(--card);
  border-radius:12px;
  padding:24px;
  margin-bottom:24px;
  border:1px solid var(--border);
  box-shadow:0 8px 24px rgba(0,0,0,0.4);
  animation:fadeIn 0.8s ease;
  transition:transform 0.3s ease, box-shadow 0.3s ease;
}

.section:hover{
  transform:translateY(-4px);
  box-shadow:0 12px 32px rgba(0,0,0,0.5);
}

h2{
  color:var(--accent);
  font-size:18px;
  margin-bottom:16px;
  display:flex;
  align-items:center;
  gap:8px;
}

label{
  display:block;
  font-weight:600;
  margin-bottom:8px;
  color:#cbd5e1;
  font-size:13px;
}

textarea{
  width:100%;
  padding:12px;
  border-radius:8px;
  background:#0b0f13;
  color:#e6edf3;
  border:1px solid var(--border);
  font-size:14px;
  font-family:'Courier New',monospace;
  min-height:120px;
  resize:vertical;
  transition:border-color 0.3s ease, box-shadow 0.3s ease;
}

textarea:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(88,166,255,0.1);
}

.btn{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 18px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  font-weight:600;
  font-size:14px;
  transition:all 0.3s ease;
  position:relative;
  overflow:hidden;
}

.btn::before{
  content:'';
  position:absolute;
  top:50%;
  left:50%;
  width:0;
  height:0;
  border-radius:50%;
  background:rgba(255,255,255,0.2);
  transform:translate(-50%,-50%);
  transition:width 0.6s, height 0.6s;
}

.btn:hover::before{
  width:300px;
  height:300px;
}

.btn:active{
  transform:scale(0.95);
}

.btn-primary{
  background:var(--accent);
  color:#071023;
}

.btn-primary:hover{
  background:#4a8fd9;
  box-shadow:0 6px 20px rgba(88,166,255,0.4);
  transform:translateY(-2px);
}

.btn-green{
  background:var(--accent2);
  color:#071023;
}

.btn-green:hover{
  background:#26843b;
  box-shadow:0 6px 20px rgba(46,160,67,0.4);
  transform:translateY(-2px);
}

.btn-ghost{
  background:transparent;
  color:var(--muted);
  border:1px solid var(--border);
}

.btn-ghost:hover{
  background:var(--panel);
  border-color:var(--muted);
}

.btn:disabled{
  opacity:0.5;
  cursor:not-allowed;
  transform:none !important;
}

.btn-group{
  display:flex;
  gap:10px;
  margin-top:12px;
  flex-wrap:wrap;
}

.key-grid{
  display:grid;
  grid-template-columns:1fr 1fr auto;
  gap:12px;
  align-items:start;
}

.key-col{
  display:flex;
  flex-direction:column;
  gap:8px;
}

.spinner{
  display:inline-block;
  width:16px;
  height:16px;
  border:2px solid rgba(255,255,255,0.3);
  border-top-color:#fff;
  border-radius:50%;
  animation:spin 0.8s linear infinite;
}

.status{
  display:inline-flex;
  align-items:center;
  gap:8px;
  margin-left:12px;
  font-size:13px;
  color:#9aa6b2;
  animation:pulse 1.5s ease infinite;
}

.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
}

@media (max-width:768px){
  .key-grid{
    grid-template-columns:1fr;
  }
  .grid{
    grid-template-columns:1fr;
  }
  .nav{
    flex-direction:column;
    gap:12px;
  }
}
</style>
</head>
<body>

<nav class="nav">
  <div class="nav-title">
    RSA Encryption System
  </div>
  <div class="nav-links">
    <a href="#" class="nav-btn active" onclick="return false;">Encrypt</a>
    <a href="decrypt.html" class="nav-btn" onclick="navigateTo('decrypt')">Decrypt</a>
    <a href="log.html" class="nav-btn" onclick="navigateTo('log')">Logs</a>
  </div>
</nav>

<div class="wrap">
  <div class="container">
    
    <div class="section">
      <h2>Generate RSA Keys</h2>
      <div style="margin-bottom:16px;">
        <button id="btnGenerate" class="btn btn-primary">
          Generate Keys (512-bit primes)
        </button>
        <button id="btnClearKeys" class="btn btn-ghost">Clear Keys</button>
        <span id="genStatus" class="status" style="display:none;">
          <span class="spinner"></span>
          <span id="statusText">Generating...</span>
        </span>
      </div>

      <div class="key-grid">
        <div class="key-col">
          <label>Public Key (e, n)</label>
          <textarea id="publicKey" rows="3" readonly placeholder='["e","n"]'></textarea>
        </div>
        <div class="key-col">
          <label>Private Key (d, n)</label>
          <textarea id="privateKey" rows="3" readonly placeholder='["d","n"]'></textarea>
        </div>
        <div class="key-col">
          <button class="btn btn-green" onclick="copyToClipboard('publicKey')">
            Copy Public
          </button>
          <button class="btn btn-green" onclick="copyToClipboard('privateKey')">
            Copy Private
          </button>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>Enkripsi Data</h2>
      <div class="grid">
        <div>
          <label>Plain Text</label>
          <textarea id="plainText" placeholder="Masukkan pesan yang akan dienkripsi..."></textarea>
          <div class="btn-group">
            <button class="btn btn-primary" id="btnEncrypt">
              <span id="encryptIcon">Encrypt</span>
            </button>
            <button class="btn btn-ghost" id="btnSample">Sample</button>
            <button class="btn btn-ghost" onclick="clearField('plainText')">Clear</button>
          </div>
        </div>

        <div>
          <label>Cipher Text</label>
          <textarea id="cipherText" placeholder="Hasil enkripsi akan muncul di sini..." readonly></textarea>
          <div class="btn-group">
            <button class="btn btn-ghost" onclick="clearField('cipherText')">Clear</button>
            <button class="btn btn-ghost" onclick="copyToClipboard('cipherText')">Copy</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
const LOG_KEY = 'rsa_uas_logs_v2';
const STORAGE_PREFIX = 'rsa_app_';

function saveToStorage(key, value) {
  try {
    localStorage.setItem(STORAGE_PREFIX + key, value);
  } catch(e) {
    console.error('Storage error:', e);
  }
}

function loadFromStorage(key) {
  try {
    return localStorage.getItem(STORAGE_PREFIX + key) || '';
  } catch(e) {
    return '';
  }
}

function navigateTo(page) {
  savePageState();
  window.location.href = page === 'encrypt' ? 'encrypt.html' : (page === 'decrypt' ? 'decrypt.html' : 'logs.html');
}

function savePageState() {
  saveToStorage('publicKey', document.getElementById('publicKey').value);
  saveToStorage('privateKey', document.getElementById('privateKey').value);
  saveToStorage('plainText', document.getElementById('plainText').value);
  saveToStorage('cipherText', document.getElementById('cipherText').value);
}

function loadPageState() {
  document.getElementById('publicKey').value = loadFromStorage('publicKey');
  document.getElementById('privateKey').value = loadFromStorage('privateKey');
  document.getElementById('plainText').value = loadFromStorage('plainText');
  document.getElementById('cipherText').value = loadFromStorage('cipherText');
}

function nowTimestamp() {
  const d = new Date();
  const YYYY = d.getFullYear();
  const MM = String(d.getMonth()+1).padStart(2,'0');
  const DD = String(d.getDate()).padStart(2,'0');
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  const ss = String(d.getSeconds()).padStart(2,'0');
  return `${YYYY}-${MM}-${DD} ${hh}:${mm}:${ss}`;
}

async function sha256BytesFromText(text){
  const data = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest('SHA-256', data);
  return new Uint8Array(buf);
}

function bytesToHex(uint8arr){ 
  return Array.from(uint8arr).map(b=>b.toString(16).padStart(2,'0')).join(''); 
}

function modPow(base, exp, mod){
  base = base % mod;
  let result = 1n;
  while (exp > 0n){
    if (exp & 1n) result = (result * base) % mod;
    base = (base * base) % mod;
    exp >>= 1n;
  }
  return result;
}

function egcd(a,b){
  if (a === 0n) return [b, 0n, 1n];
  const [g, x1, y1] = egcd(b % a, a);
  const x = y1 - (b / a) * x1;
  const y = x1;
  return [g, x, y];
}

function modInverse(e, phi){
  const [g, x] = egcd(e, phi);
  if (g !== 1n) return null;
  return (x % phi + phi) % phi;
}

function bitLength(n){ 
  return n.toString(2).length; 
}

function bytesToBigInt(byteArray) {
  let result = 0n;
  for (let i = 0; i < byteArray.length; i++) {
    result = (result << 8n) | BigInt(byteArray[i]);
  }
  return result;
}

function bigIntToBytes(bigint) {
  if (bigint === 0n) return [0];
  const bytes = [];
  let temp = bigint;
  while (temp > 0n) {
    bytes.unshift(Number(temp & 0xFFn));
    temp = temp >> 8n;
  }
  return bytes;
}

function chunkArray(arr, size){
  const out = [];
  for (let i = 0; i < arr.length; i += size) {
    out.push(arr.slice(i, i + size));
  }
  return out;
}

function randomBytes(len){
  const b = new Uint8Array(len);
  crypto.getRandomValues(b);
  return b;
}

function randomBigInt(bits){
  const bytes = Math.ceil(bits/8);
  const rnd = randomBytes(bytes);
  rnd[0] |= 1 << ((bits-1) % 8);
  rnd[rnd.length-1] |= 1;
  let r = 0n;
  for (let i=0;i<rnd.length;i++) r = (r << 8n) + BigInt(rnd[i]);
  return r;
}

function isProbablyPrime(n, k=12){
  if (n < 2n) return false;
  const small = [2n,3n,5n,7n,11n,13n,17n,19n,23n,29n,31n];
  for (let p of small){
    if (n === p) return true;
    if (n % p === 0n) return false;
  }
  let d = n - 1n;
  let s = 0n;
  while ((d & 1n) === 0n){ d >>= 1n; s += 1n; }
  for (let i=0;i<k;i++){
    let a;
    do {
      const aBits = Math.min(64, Math.max(16, bitLength(n)-2));
      const rnd = randomBigInt(aBits);
      a = 2n + (rnd % (n - 4n));
    } while (a < 2n || a > n-2n);
    let x = modPow(a, d, n);
    if (x === 1n || x === n-1n) continue;
    let cont = false;
    for (let r=1n; r < s; r++){
      x = (x * x) % n;
      if (x === n-1n){ cont = true; break; }
    }
    if (cont) continue;
    return false;
  }
  return true;
}

async function generatePrime(bits){
  while (true){
    await new Promise(r=>setTimeout(r,0));
    const p = randomBigInt(bits);
    if (isProbablyPrime(p, 12)) return p;
  }
}

function storeKeyFields(eBig, dBig, nBig){
  document.getElementById('publicKey').value = JSON.stringify([eBig.toString(), nBig.toString()]);
  document.getElementById('privateKey').value = JSON.stringify([dBig.toString(), nBig.toString()]);
  savePageState();
}

function parseKeyField(id){
  const v = document.getElementById(id).value.trim();
  if (!v) throw new Error('Key kosong');
  try {
    const arr = JSON.parse(v);
    if (!Array.isArray(arr) || arr.length < 2) throw new Error('Format key invalid');
    return [BigInt(arr[0]), BigInt(arr[1])];
  } catch(e) {
    const parts = v.replace(/[\[\]\s]/g,'').split(',');
    if (parts.length < 2) throw new Error('Key tidak valid');
    return [BigInt(parts[0]), BigInt(parts[1])];
  }
}

function base64EncodeUnicode(str){
  const bytes = new TextEncoder().encode(str);
  let binary = '';
  for (let i=0;i<bytes.length;i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
}

function saveLog(obj){ 
  try{ 
    const arr = JSON.parse(localStorage.getItem(LOG_KEY) || '[]');
    arr.unshift(obj); 
    if (arr.length > 100) arr.length = 100;
    localStorage.setItem(LOG_KEY, JSON.stringify(arr)); 
  } catch(e){ 
    console.error('Save log error:', e); 
  } 
}

async function generateKeys(){
  const btnGen = document.getElementById('btnGenerate');
  const status = document.getElementById('genStatus');
  const statusText = document.getElementById('statusText');
  
  try {
    btnGen.disabled = true;
    status.style.display = 'inline-flex';
    
    statusText.textContent = 'Generating prime p (512-bit)...';
    const p = await generatePrime(512);
    
    statusText.textContent = 'Generating prime q (512-bit)...';
    let q;
    do { q = await generatePrime(512); } while (q === p);
    
    statusText.textContent = 'Computing keys...';
    const n = p * q;
    const phi = (p - 1n) * (q - 1n);
    const e = 65537n;
    const d = modInverse(e, phi);
    if (d === null) throw new Error('Failed to compute d.');

    storeKeyFields(e,d,n);
    
    const publicKeyStr = document.getElementById('publicKey').value;
    saveLog({ 
      ts: nowTimestamp(), 
      action: 'generate_keys',
      publicKey: publicKeyStr,
      keySize: '1024-bit (512-bit primes)'
    });
    
    statusText.textContent = 'Keys generated successfully!';
    setTimeout(() => { status.style.display = 'none'; }, 2000);
    
  } catch(err){
    alert('Generate error: ' + (err.message || err));
    status.style.display = 'none';
  } finally {
    btnGen.disabled = false;
  }
}

async function encryptText(){
  const btnEncrypt = document.getElementById('btnEncrypt');
  const icon = document.getElementById('encryptIcon');
  
  try {
    const [e, n] = parseKeyField('publicKey');
    const plain = document.getElementById('plainText').value || '';
    if (!plain){ alert('Masukkan plain text!'); return; }

    btnEncrypt.disabled = true;
    icon.textContent = 'Encrypting...';

    const hashBytes = await sha256BytesFromText(plain);
    const plainBytes = new TextEncoder().encode(plain);
    const nBits = bitLength(n);
    const maxBlockSize = Math.floor((nBits - 1) / 8) - 1;

    const hashChunks = chunkArray(Array.from(hashBytes), maxBlockSize);
    const encryptedHashBlocks = [];
    
    for (const chunk of hashChunks) {
      const m = bytesToBigInt(chunk);
      const c = modPow(m, e, n);
      encryptedHashBlocks.push(c.toString());
      await new Promise(r => setTimeout(r, 0));
    }

    const plainChunks = chunkArray(Array.from(plainBytes), maxBlockSize);
    const encryptedPlainBlocks = [];
    
    for (const chunk of plainChunks) {
      const m = bytesToBigInt(chunk);
      const c = modPow(m, e, n);
      encryptedPlainBlocks.push(c.toString());
      await new Promise(r => setTimeout(r, 0));
    }

    const meta = {
      hashLen: hashBytes.length,
      plainLen: plainBytes.length,
      blockSize: maxBlockSize
    };

    const metaB64 = base64EncodeUnicode(JSON.stringify(meta));
    const cipher = `${metaB64} ||| ${encryptedHashBlocks.join('|')} ||| ${encryptedPlainBlocks.join('|')}`;

    document.getElementById('cipherText').value = cipher;
    savePageState();

    const publicKeyStr = document.getElementById('publicKey').value;
    saveLog({ 
      ts: nowTimestamp(), 
      action: 'encrypt',
      publicKey: publicKeyStr,
      hash: bytesToHex(hashBytes), 
      plaintextLength: plain.length,
      cipherLength: cipher.length 
    });
    
    icon.textContent = '✓';
    setTimeout(() => { icon.textContent = 'Encrypt'; }, 1500);
    alert('Enkripsi berhasil!');
    
  } catch(err){
    icon.textContent = '✗';
    setTimeout(() => { icon.textContent = 'Encrypt'; }, 1500);
    alert('Encrypt error: ' + (err.message || err));
  } finally {
    btnEncrypt.disabled = false;
  }
}

function copyToClipboard(id){
  const v = document.getElementById(id).value;
  if(!v) { alert('Tidak ada yang disalin'); return; }
  navigator.clipboard.writeText(v).then(()=>alert('Copied!')).catch(()=>alert('Gagal menyalin'));
}

function clearField(id){ 
  document.getElementById(id).value = '';
  savePageState();
}

function clearKeys(){
  document.getElementById('publicKey').value = '';
  document.getElementById('privateKey').value = '';
  savePageState();
}

function generateSamplePlain(){ 
  document.getElementById('plainText').value = 'Proyek ini berhasil mengimplementasikan RSA 1024-bit secara lengkap di sisi client. Integritas data terjamin melalui SHA-256, dan struktur modular memungkinkan pemahaman mudah atas keseluruhan sistem.';
  savePageState();
}

document.getElementById('btnGenerate').addEventListener('click', generateKeys);
document.getElementById('btnClearKeys').addEventListener('click', clearKeys);
document.getElementById('btnEncrypt').addEventListener('click', encryptText);
document.getElementById('btnSample').addEventListener('click', generateSamplePlain);

document.getElementById('plainText').addEventListener('input', savePageState);
document.getElementById('cipherText').addEventListener('input', savePageState);

window.addEventListener('load', loadPageState);

</script>
</body>
</html>